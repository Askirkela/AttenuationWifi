var selectTool=a=>{resetTool(),currentMaterial="";try{if(currentTool=tools[a],3===a){var b=select.options;currentMaterial=b[b.selectedIndex].value}}catch(a){alert("An error occured while selecting the tool : "+a)}currState()},placeSource=(a,b)=>{existingsrc||currentTool!==tools[0]&&currentTool!==tools[1]||(src.x=a,src.y=b,existingsrc=!0,drawSource(a,b),writeMessage(canvas,"S",a-1,b+17),currentTool===tools[0]?srcFreq="low":srcFreq="high",resetTool())},placeReceptor=(a,b)=>{currentTool===tools[2]&&(receptor.push({x:a,y:b}),drawReceptor(a,b),writeMessage(canvas,receptor.length,a-2,b+17),resetTool())},placeWall=(a,b,c,d)=>{if(currentTool===tools[3]){var e=select.selectedIndex;console.log("Selected Material : "+materials[e]);var f=materials[e];ctxWalls.lineWidth=5,ctxWalls.strokeStyle=materialsProperties[f].color,drawSquare2(a,b,c,d),walls.push({x:a,y:b,u:c,v:d,color:materialsProperties[f].color})}},getDistance=(a,b)=>{return Math.abs(Math.sqrt(Math.pow(a.x-a.y,2)+Math.pow(b.x-b.y,2)))},getAirAttenuation=(a,b)=>{var c="low"==a?2.4:5.8;return Math.floor(92.45+20*Math.log10(c)+20*Math.log10(b/1e3))},getMaterialsAttenuation=(a,b)=>{if(!b)return 0;var c=0;return b.forEach(b=>{c+="low"==a?materialsProperties[b].low:materialsProperties[b].high}),c},getTotalAttenuation=(a,b,c)=>{return srcStrength-getAirAttenuation(a,b)-getMaterialsAttenuation(a,c)},getSignalStrength=(a,b,c)=>{var d=getTotalAttenuation(a,getDistance(b,c),getPassedMaterials(b,c));return d>-77?"Excellent":d>-86?"Good":d>-92?"Weak":"None"},getPassedMaterials=(a,b)=>{for(var c=[],d=a.x,e=a.y,f=b.x,g=b.y,h=Math.abs(f-d),i=Math.abs(g-e),j=d<f?2:-2,k=e<g?2:-2,l=h-i;d!=f||e!=g;){var m=ctxWalls.getImageData(d,e,1,1).data,n="#"+("000000"+rgbToHex(m[0],m[1],m[2])).slice(-6);for(var o in materialsProperties)n===materialsProperties[o].color&&c.push(o);var p=2*l;p>-i&&(l-=i,d+=j),p<h&&(l+=h,e+=k)}return c.filter((a,b)=>{return b%2===0})},rgbToHex=(a,b,c)=>{if(a>255||b>255||c>255)throw"Invalid color component";return(a<<16|b<<8|c).toString(16)},drawSource=(a,b)=>{drawSquare(a,b,"blue")},removeSource=()=>{existingsrc&&(ctx.clearRect(src.x,src.y,10,20),src={x:-1,y:-1},existingsrc=!1,srcFreq="",resetTool(),currState())},removeReceptor=()=>{receptor&&(receptor.forEach(a=>{ctx.clearRect(a.x,a.y,10,20)}),receptor=[],resetTool(),currState())},removeWalls=()=>{ctxWalls.clearRect(0,0,canvas.width,canvas.height),walls=[],resetTool(),currState()},drawReceptor=(a,b)=>{drawSquare(a,b,"green")},getMousePos=(a,b)=>{var c=a.getBoundingClientRect();return{x:b.clientX-c.left-(b.clientX-c.left)%10,y:b.clientY-c.top-(b.clientY-c.top)%10}},writeMessage=(a,b,c,d)=>{ctx.font="18pt Calibri",ctx.fillStyle="black",ctx.fillText(b,c,d)},drawSquare=(a,b,c)=>{ctx.fillStyle=c,ctx.fillRect(a,b,10,20)},drawSquare2=(a,b,c,d)=>{ctxWalls.beginPath(),ctxWalls.moveTo(a,b),ctxWalls.lineTo(c,b),ctxWalls.stroke(),ctxWalls.beginPath(),ctxWalls.moveTo(a,b),ctxWalls.lineTo(a,d),ctxWalls.stroke(),ctxWalls.beginPath(),ctxWalls.moveTo(c,b),ctxWalls.lineTo(c,d),ctxWalls.stroke(),ctxWalls.beginPath(),ctxWalls.moveTo(a,d),ctxWalls.lineTo(c,d),ctxWalls.stroke()},clearCanvas=()=>{resetTool(),removeSource(),removeReceptor(),removeWalls(),ctx.clearRect(0,0,canvas.width,canvas.height),currState()},resetTool=()=>{currentTool=tools[4]},dispatch=a=>{switch(currentTool){case tools[0]:placeSource(mousePos.x,mousePos.y);break;case tools[1]:placeSource(mousePos.x,mousePos.y);break;case tools[2]:placeReceptor(mousePos.x,mousePos.y);break;case tools[3]:console.log("Called to place a wall")}},currState=()=>{var a=$("#infocurtool")[0],b=$("#infocurmat")[0],c=$("#infoexistingsource")[0],d=$("#infosourcepos")[0],e=$("#inforeceptorpos")[0],f=$("#infomousepos")[0],g=$("#infowalls")[0];a.innerText=currentTool,b.innerText=currentMaterial,c.innerText=existingsrc,d.innerText=JSON.stringify(src),e.innerText=JSON.stringify(receptor),f.innerText=JSON.stringify(mousePos),g.innerText=JSON.stringify(walls);var h=$("#sigatn")[0],i=$("#sigstr")[0];removeChildren(h),removeChildren(i),receptor.map((a,b)=>{var c=$("<div />",{class:"col-md-4",text:"Receptor "+(b+1)+" : "+getTotalAttenuation(srcFreq,getDistance(src,a),getPassedMaterials(src,a))});c.appendTo(h),c=$("<div />",{class:"col-md-4",text:"Receptor "+(b+1)+" : "+getSignalStrength(srcFreq,src,a)}),c.appendTo(i)})},removeChildren=a=>{for(;a.lastChild;)a.removeChild(a.lastChild)},drawBackCanvas=()=>{ctxBack.strokeStyle="#999";for(var a=0;a<backCanvas.height;a+=10)ctxBack.beginPath(),ctxBack.moveTo(0,a),ctxBack.lineTo(backCanvas.width,a),ctxBack.stroke();for(var a=0;a<backCanvas.width;a+=10)ctxBack.beginPath(),ctxBack.moveTo(a,0),ctxBack.lineTo(a,backCanvas.height),ctxBack.stroke()},goDark=()=>{$("body").toggleClass("dark")},showDebug=()=>{$("#debug").toggle()};